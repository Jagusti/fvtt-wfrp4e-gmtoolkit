{"_id":"2sefSFqqAbySw2nz","name":"Reduce Advantage","type":"script","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/advantage-reduce.svg","scope":"global","command":"/* Reduces Advantage for the selected token by 1 (to minimum 0).\n*/\n\ngame.gmtoolkit.advantage.updateAdvantage(token,\"reduce\");","folder":null,"sort":0,"permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"flags":{}}
{"_id":"6EKiEQZTbmQN97Vr","name":"Clear Advantage","type":"script","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/advantage-clear.svg","scope":"global","command":"/* Resets Advantage for the selected token to 0 */\n\ngame.gmtoolkit.advantage.updateAdvantage(token,\"clear\");","folder":null,"sort":0,"permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"flags":{}}
{"_id":"6UwKY8nGZyXzAXCa","name":"Toggle Scene Visibility and Light","permission":{"default":0,"h21fB4dFvdDBRcFD":3},"type":"script","flags":{"furnace":{"runAsGM":false}},"scope":"global","command":"/* Toggles the Token Vision and Global Illumination settings. \n * If Token Vision is set, Global Illumination is unset (and vice-versa).\n * Applies to the scene being viewed, which is not necessarily the active scene.\n */\n\n\nlet thisScene = game.scenes.viewed;\nlet uiNotice = game.i18n.format(\"GMTOOLKIT.Message.UnexpectedNoChange\", {});\n\nif (thisScene.data.tokenVision) {\n  thisScene.update({tokenVision: false, globalLight: true});\n  uiNotice = game.i18n.format(\"GMTOOLKIT.Scene.GlobalNotToken\", {sceneName: thisScene.name}, {});\n} else {\n  thisScene.update({tokenVision: true, globalLight: false});\n  uiNotice = game.i18n.format(\"GMTOOLKIT.Scene.TokenNotGlobal\", {sceneName: thisScene.name}, {});\n}\n\nui.notifications.notify(uiNotice);","author":"h21fB4dFvdDBRcFD","img":"modules/wfrp4e-gm-toolkit/assets/icons/toggle-scene-light.svg","actorIds":[]}
{"_id":"AjUYYy7qAN55BERN","name":"Add Advantage","type":"script","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/advantage-add.svg","scope":"global","command":"/* Increases Advantage for the selected token by 1.\n * Caps at character's maximum advantage. \n*/\n\ngame.gmtoolkit.advantage.updateAdvantage(token,\"increase\");","folder":null,"sort":0,"permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"flags":{}}
{"_id":"DGYdRmtbMZ81NmQ3","name":"Set Token Vision and Light","type":"script","author":"Zo7HSQ75uO8dWUkH","img":"modules/wfrp4e-gm-toolkit/assets/icons/set-token-vision-light.svg","scope":"global","command":"setTokenVisionLight();\n\nasync function canvasTokensUpdate(data) {\n  const updates = canvas.tokens.controlled.map(token => mergeObject({_id: token.id}, data));\n  await canvas.scene.updateEmbeddedDocuments(\"Token\", updates)\n}\n\nasync function setTokenVisionLight() { \n  if (canvas.tokens.controlled.length < 1) return ui.notifications.error( game.i18n.localize(\"GMTOOLKIT.Token.Select\"),{} );\n\n  let applyChanges = false;\n\n  new Dialog({\n      title: game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.Title\"),\n      content: `\n        <form> \n          <div class=\"form-group\">\n            <label>\n            ${game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.VisionType\")}\n          </label>\n            <select id=\"vision-type\" name=\"vision-type\"> \n              <option value=\"normalVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Normal\")} \n              </option> \n              <option value=\"blindedVision\"> \n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Blinded\")} \n              </option>\n              <option value=\"nightVision\"> \n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Night\")} \n              </option>\n              <option value=\"darkVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Dark\")} \n              </option>\n              <option value=\"noVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.None\")} \n              </option>\n            </select>\n          </div>\n          <div class=\"form-group\">\n            <label>\n            ${game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.LightSource\")} \n            </label>\n            <select id=\"light-source\" name=\"light-source\">\n              <option value=\"none\"> \n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.NoLight\")}\n              </option>\n              <option value=\"matches\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Matches\")} \n              </option>\n              <option value=\"candle\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Candle\")} \n              </option>\n              <option value=\"davrich-lamp\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.DavrichLamp\")} \n              </option>\n              <option value=\"torch\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Torch\")}\n              </option>\n              <option value=\"lantern\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Lantern\")}\n              </option>\n              <option value=\"storm-broad\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.StormLantern.Dim\")} \n              </option>\n              <option value=\"storm-narrow\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.StormLantern.Bright\")} \n              </option>\n              <option value=\"storm-shut\"> \n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.StormLantern.Shut\")}\n              </option>\n              <option value=\"ablaze\"> \n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Ablaze\")} \n              </option>\n              <option value=\"light\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Light\")}\n              </option>\n              <option value=\"witchlight\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Witchlight\")}\n              </option>\n              <option value=\"glowing-skin\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.GlowingSkin\")}\n              </option>\n              <option value=\"soulfire\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Soulfire\")} \n              </option>\n              <option value=\"pha\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Pha\")} \n              </option>\n            </select>\n          </div>\n        </form>\n        `,\n      buttons: {\n        yes: {\n          icon: \"<i class='fas fa-check'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n          callback: () => applyChanges = true\n        },\n        no: {\n          icon: \"<i class='fas fa-times'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\"),\n        },\n      },\n      default: \"yes\",\n      close: async (html) => {\n        if (applyChanges) {\n\n          for ( let token of canvas.tokens.controlled ) {\n            \n            // Define a set of baseline values. Light Source and Vision choices will only change the properties that differ. Not all of the options available since Foundry v9 are used.\n            // Baseline Vision Values\n            let advNightVision = 0;\n            let dimSight = 0;\n            let brightSight = 0;\n            let sightAngle = 360;\n            // Baseline Light Source Values\n            let dimLight = 0;\n            let brightLight = 0;  \n            let lightAngle = 360;\n            let lightColor = null; \n            let lightColorIntensity = 0;\n            let animationIntensity = 1;\n            let animationSpeed = 1;\n            let animationType = \"none\";\n\n            let visionType = html.find('[name=\"vision-type\"]')[0].value; // TODO: default vision option based on condition -> trait -> talent. Issue Log: https://github.com/Jagusti/fvtt-wfrp4e-gmtoolkit/issues/42\n            let item; // used for finding whether token has Night Vision or Dark Vision \n            let lightSource = html.find('[name=\"light-source\"]')[0].value;\n        \n            // Get Light Source Values\n            switch (lightSource) {\n              case \"none\":\n              case \"storm-shut\":\n                dimLight = 0;\n                break;\n              case \"matches\":\n                dimLight = 5;\n                brightLight = 2;\n                lightColor = \"#ffaa00\";\n                lightColorIntensity = 0.3;\n                animationIntensity = 8;\n                animationSpeed = 8;\n                animationType = \"torch\";\n                break;\n              case \"candle\":\n                dimLight = 10;\n                brightLight = 5;\n                lightColor = \"#ffaa00\";\n                lightColorIntensity = 0.3;\n                animationIntensity = 8;\n                animationSpeed = 8;\n                animationType = \"torch\";\n                break;\n              case \"davrich-lamp\":\n                dimLight = 10;\n                brightLight = 5;\n                lightColor = \"#ffaa00\";\n                lightColorIntensity = 0.4;\n                animationIntensity = 4;\n                animationSpeed = 4;\n                animationType = \"torch\";\n                break;\n              case \"torch\":\n                dimLight = 15;\n                brightLight = 7.5;\n                lightColor = \"#ffaa00\";\n                lightColorIntensity = 0.5;\n                animationIntensity = 7;\n                animationSpeed = 7;\n                animationType = \"torch\"\n                break;\n              case \"lantern\":\n                dimLight = 20;\n                brightLight = 10;\n                lightColor = \"#ffcc66\";\n                lightColorIntensity = 0.7;\n                animationIntensity = 3;\n                animationSpeed = 3;\n                animationType = \"torch\";\n                break;\n              case \"storm-broad\":\n                dimLight = 20;\n                brightLight = 10;\n                lightColor = \"#ffcc66\";\n                lightColorIntensity = 0.5;\n                animationIntensity = 1;\n                animationSpeed = 2;\n                animationType = \"torch\";\n                break;\n              case \"storm-narrow\":\n                dimLight = 30;\n                brightLight = 20;\n                lightColor = \"#ffcc66\";\n                lightColorIntensity = 0.7;\n                animationIntensity = 1;\n                animationSpeed = 1;\n                animationType = \"torch\";\n                lightAngle = 90;\n                break;\n              case \"light\":\n                dimLight = 15;\n                brightLight = 7.5;\n                lightColor = \"#99ffff\";\n                lightColorIntensity = 0.5;\n                animationIntensity = 3;\n                animationSpeed = 2;\n                animationType = \"pulse\"\n                break;\n              case \"witchlight\":\n                dimLight = 20;\n                brightLight = 10;\n                lightColor = \"#99ffff\";\n                lightColorIntensity = 0.7;\n                animationIntensity = 6;\n                animationSpeed = 2;\n                animationType = \"chroma\"\n                break;\n              case \"glowing-skin\":\n                dimLight = 10;\n                brightLight = 3;\n                lightColor = \"#ffbd80\";\n                lightColorIntensity = 0.3;\n                animationIntensity = 2;\n                animationSpeed = 2;\n                animationType = \"pulse\";\n                break;\n              case \"ablaze\":\n                dimLight = 15;\n                brightLight = 7.5;\n                lightColor = \"#ff7733\";\n                lightColorIntensity = 0.5;\n                animationIntensity = 7;\n                animationSpeed = 7;\n                animationType = \"torch\"\n                break;\n              case \"pha\":\n                dimLight = token.actor.data.data.characteristics.wp.bonus;\n                brightLight = token.actor.data.data.characteristics.wp.bonus;\n                lightColor = \"#ffddbb\";\n                lightColorIntensity = 0.6;\n                animationIntensity = 4;\n                animationSpeed = 4;\n                animationType = \"sunburst\"\n                break;\n              case \"soulfire\":\n                dimLight = 15;\n                brightLight = 7.5;\n                lightColor = \"#ff7733\";\n                lightColorIntensity = 0.5;\n                animationIntensity = 7;\n                animationSpeed = 7;\n                animationType = \"fog\"\n                break;\n              default:\n                dimLight = token.data.light.dim;\n                brightLight = token.data.light.bright;\n                lightAngle = token.data.light.angle;\n                lightColor = token.data.light.color;\n            }\n                            \n            // Get Vision Type Values\n        switch (visionType) {\n          case \"blindedVision\":\n            brightSight = 1;\n            dimSight = 0;\n            break;\n          case \"noVision\":\n            dimSight = 0;\n            brightSight = 0;\n            dimLight = 0;\n            brightLight = 0;\n            break;\n          case \"darkVision\": \n            item = token.actor.items.find(i => i.data.name.toLowerCase() == game.i18n.localize(\"GMTOOLKIT.Trait.DarkVision\").toLowerCase() );\n              if(item != undefined) {\n              dimSight = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeDarkVision\"));\n            } else { \n              (game.settings.get(\"wfrp4e-gm-toolkit\", \"overrideDarkVision\")) ? dimSight = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeDarkVision\"))  : dimSight = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\")) ;\n            }\n            brightSight = (dimSight / 2);\n            break;\n          case \"nightVision\":\n            // Night Vision requires some minimal illumination to provide a benefit\n            if (game.scenes.viewed.data.darkness < 1 | dimLight > 0 | game.scenes.viewed.data.globalLight) {\n              item = token.actor.items.find(i => i.data.name.toLowerCase() == game.i18n.localize(\"GMTOOLKIT.Talent.NightVision\").toLowerCase() );\n                if(item == undefined) { \n                  (game.settings.get(\"wfrp4e-gm-toolkit\", \"overrideNightVision\")) ? advNightVision = 1  : advNightVision = 0 ;\n                } else { \n                  for (let item of token.actor.items)\n                    {\n                      if (item.name.toLowerCase() == game.i18n.localize(\"GMTOOLKIT.Talent.NightVision\").toLowerCase() ) {\n                        switch (item.type) {\n                          case \"trait\" :\n                            advNightVision = 1;\n                            break;\n                          case \"talent\" :\n                            advNightVision += item.data.data.advances.value;\n                            break;\n                        }\n                      }\n                    }\n                }\n              brightSight = (20 * advNightVision); \n              dimSight = Math.max(brightSight + dimLight, Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\")));\n              dimSight = advNightVision == 0 ? Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\")) : Math.max(brightSight + dimLight, Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\")));\n              sightAngle = lightAngle;\n            }\n            console.log(`Night Vision Advances ${advNightVision}`)\n            break;\n          case \"normalVision\":\n            dimSight = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\"));\n            brightSight = 0;\n            break;\n          default:\n            dimSight = token.data.dimSight;\n            brightSight = token.data.brightSight;\n        }\n        \n            // Update Token\n            await token.document.update({\n              \"vision\": true,\n              \"light\": {\n                \"dim\": dimLight, \n                \"bright\":  brightLight,\n                \"angle\": lightAngle,\n                \"color\": lightColor,\n                \"alpha\": lightColorIntensity,\n              },\n              \"light.animation\": {\n                \"intensity\": animationIntensity,\n                \"speed\": animationSpeed,\n                \"type\": animationType\n              },\n              \"dimSight\": dimSight,\n              \"brightSight\": brightSight,\n              \"sightAngle\": sightAngle\n              // \"visionType\": visionType,\n              // \"lightSource\": lightSource,\n              // \"advNightVision\": advNightVision\n            });\n            token.refresh(true)\n        }\n        \n        canvasTokensUpdate({\"vision\": true})\n\n        }\n      }\n    }).render(true);\n};\n\n\n/* ==========\n * MACRO: Set Token Vision and Light\n * VERSION: 0.9.1\n * UPDATED: 2022-01-02\n * DESCRIPTION: Open a dialog for quickly changing vision and lighting parameters of the selected token(s).\n * TIP: Default sight range and Darkvision / Night Vision overrides can be configured in Configure Token Vision Settings under Module Settings.\n ========== */","folder":null,"sort":0,"permission":{"default":0,"Zo7HSQ75uO8dWUkH":3},"flags":{"core":{"sourceId":"Macro.issAGdpFxchQw2zp"}}}
{"_id":"g9Wohpie7ODdbRKX","name":"Session Turnover","type":"script","author":"BsnP0LhXXtS4iz4M","img":"modules/wfrp4e-gm-toolkit/assets/icons/end-session.svg","scope":"global","command":"endSession();\n\nasync function endSession () {\n    if (!game.user.isGM) {\n        return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Message.SessionEnd.NoPermission\"), {});\n    }\n    \n    game.gmtoolkit.module.log(false, \"Processing Session Turnover.\")\n\n    game.gmtoolkit.module.log(false, \"Pausing game.\")\n    await game.togglePause(true);\n\n    game.gmtoolkit.module.log(false, `Switching to holding scene.`)\n    game.scenes.getName(game.settings.get(\"wfrp4e-gm-toolkit\", \"holdingScene\"))?.activate(true)\n    \n    game.gmtoolkit.module.log(false, \"Adding Experience.\")\n    await game.macros.getName(\"Add XP\").execute();\n    \n    game.gmtoolkit.module.log(false, \"Resetting Fortune.\")\n    await game.macros.getName(\"Reset Fortune\").execute();\n    \n    game.gmtoolkit.module.log(false, \"Exporting Chat.\")\n    if (game.settings.get(\"wfrp4e-gm-toolkit\", \"exportChat\")) {\n        await game.messages.export();\n    }; \n    \n    if (game.settings.get(\"wfrp4e-gm-toolkit\", \"sessionID\") == \"null\") {\n        game.gmtoolkit.module.log(false, `Not updating Session ID.`)\n    } else {\n        game.gmtoolkit.module.log(false, \"Updating Session ID.\")\n        const thisSession = game.gmtoolkit.utility.getSession().id \n        nextSession = Math.trunc(thisSession) == thisSession ? Number(thisSession) + 1 : thisSession;\n        \n        const dialog = new Dialog({\n            title: (game.i18n.localize(\"GMTOOLKIT.Dialog.SessionTurnover.UpdateSessionID.Title\")),\n            content: `<form>\n            <p>${game.i18n.format(\"GMTOOLKIT.Dialog.SessionTurnover.UpdateSessionID.CurrentSession\", {thisSession})}</p>\n            <div class=\"form-group\">\n            <p>${game.i18n.localize(\"GMTOOLKIT.Dialog.SessionTurnover.UpdateSessionID.NextSession\")}</p> \n            <input type=\"text\" id=\"next-session\" name=\"next-session\" value=\"${nextSession}\" />\n            </div>\n            </form>`,\n            buttons: {\n                yes: {\n                    icon: \"<i class='fas fa-check'></i>\",\n                    label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n                    callback: (html) => {\n                        nextSession = html.find(\"#next-session\").val();\n                        game.settings.set(\"wfrp4e-gm-toolkit\", \"sessionID\", nextSession)\n                        game.gmtoolkit.module.log(true, `Previous Session ID was ${thisSession}. Next Session ID is ${nextSession}.`)\n                    }\n                },\n                no: {\n                    icon: \"<i class='fas fa-times'></i>\",\n                    label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\"),\n                },\n            },\n            default: \"yes\"\n        }).render(true);\n    } // End Session ID Update\n\n    game.gmtoolkit.module.log(false, `Completed Session Turnover tasks.`)\n};\n\n/* ==========\n * MACRO: Session Turnover\n * VERSION: 0.8.0\n * UPDATED: 2021-12-30\n * DESCRIPTION: Unified macro to run start and end of session admin, including awarding Experience Points, resetting Fortune, pausing the game and exporting the chat log. \n * TIP: Various default options can be defined in Session Management Settings under Module Settings.\n ========== */","folder":null,"sort":0,"permission":{"default":0,"BsnP0LhXXtS4iz4M":3},"flags":{}}
{"_id":"ihMGjHFP3SdvYH2k","name":"Simply d100","permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"type":"chat","flags":{},"scope":"global","command":"/r 1d100","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/d100.svg","actorIds":[]}
{"name":"GM Toolbox","type":"script","author":"WpuDIfNQnefaTyuV","img":"modules/wfrp4e-gm-toolkit/assets/icons/macro-chest.svg","scope":"global","command":"(()=>{\n    // Add and remove macros from the list as needed. \n    const macros = [\n        \"Add Advantage\",\n        \"Clear Advantage\",\n        \"Reduce Advantage\", \n        \"Session Turnover\",\n        \"Add XP\",\n        \"Reset Fortune\",\n        \"Make Secret Party Test\",\n        \"Send Dark Whispers\",\n        \"Toggle Scene Visibility and Light\",\n        \"Set Token Vision and Light\",\n        \"Pull Everyone to Scene\", \n        \"Simply d100\"\n    ];\n\n    let buttons = {};\n    let dialog;\n    let content = `<div style=\"width: 100%; `; // closing this bracket seems to break the form\n    \n    macros.forEach((name)=> {\n        buttons[name] = {\n        label : name,\n        icon : `<img src = \"${game.macros.getName(name).data.img}\" style = \"height: 2rem; vertical-align : middle; border: none;\" >`,\n        callback : () => {\n            game.macros.getName(name).execute();\n            dialog.render(true);\n        }\n        }\n    });\n    dialog = new Dialog({title : game.i18n.localize(\"GMTOOLKIT.Dialog.GMToolbox.Title\"), content, buttons}).render(true);\n})();\n  \n  \n/* ==========\n* MACRO: GM Toolbox\n* VERSION: 0.8.0\n* UPDATED: 2021-12-31\n* DESCRIPTION: Adds a customisable floating dialog for quick access to frequently used Toolkit macros, freeing up hotbar spots\n* TIP: Add / remove macros from the 'macros' list to tailor it for your game. Names must exactly match those in the Macro Directory.\n* TIP: The macro dialog can be kept open for quick access and minimised to reduce space\n========== */","folder":null,"sort":0,"permission":{"default":0,"WpuDIfNQnefaTyuV":3},"flags":{"core":{"sourceId":"Macro.bY0sF26Vj0OhXwQ5"}},"_id":"iopoLXTz9kfDTfiX"}
{"_id":"pZmPtsEZHOpyJfnq","name":"Reset Fortune","type":"script","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/reset-fortune.svg","scope":"global","command":"resetFortune();\n\nfunction resetFortune() {\n// setup: exit with notice if there are no player-owned characters\n\tparty = Array.from(game.actors).filter(pc => pc.hasPlayerOwner && pc.type == 'character'); \n\tif (party.length == 0) return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.ResetFortune.NoPlayerCharacters\")); \n\tlet chatContent = \"\"\n\n// cycle through player characters, updating Fortune and building a report message\n\tparty.forEach (character => {\n\t\tcurrentFortune = character.data.data.status.fortune.value\n\t\tmaxFortune = getMaxFortune(character);\n\t\tcharacter.update({'data.status.fortune.value': maxFortune})\n\t\tchatContent += `${character.name}:  ${currentFortune} -> ${maxFortune} <br>`\n\t});\n\n// confirm changes made in chat\n\tlet chatData = {\n\t\tuser: game.user.id,\n\t\tcontent: chatContent, \n\t\tflavor: game.i18n.localize(\"GMTOOLKIT.ResetFortune.Restored\") \n\t};\n\tChatMessage.create(chatData, {});  \n}\n\n// Calculate the Fortune target to be restored, based on Fate and Luck talent advances\nfunction getMaxFortune(target) {\n    let advLuck = 0;\n    let item = target.items.find(i => i.name === game.i18n.localize(\"GMTOOLKIT.Talent.Luck\") )\n\tif(!(item == undefined || item.data.data.advances.value < 1)) { \n\t\tfor (let item of target.items)\n\t\t\t{\n\t\t\t\tif (item.type == \"talent\" && item.name == game.i18n.localize(\"GMTOOLKIT.Talent.Luck\"))\n\t\t\t\t\t{\n\t\t\t\t\t\tadvLuck += item.data.data.advances.value;\n\t\t\t\t\t}\n\t\t\t}\n\t\t} \n    return  target.status.fate.value + advLuck\n}\n\n/* ==========\n * MACRO: Reset Fortune\n * VERSION: 0.8.0\n * UPDATED: 2021-11-12\n * DESCRIPTION: Restores Fortune to the Fate level of player character(s). Applies any Luck talent bonus.\n * TIP: Characters must have a player assigned. \n ========== */","folder":null,"sort":0,"permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"flags":{}}
{"_id":"roGO31Lo4pyL5kvg","name":"Send Dark Whispers","type":"script","author":"Zo7HSQ75uO8dWUkH","img":"modules/wfrp4e-gm-toolkit/assets/icons/dark-whispers.svg","scope":"global","command":"formDarkWhispers(); //  Set default user target filter in module settings. Override by adding parameter to \"all\", \"absent\" or \"present\" party members. Clear parameter to revert to default. \n\nasync function formDarkWhispers(targets=String(game.settings.get(\"wfrp4e-gm-toolkit\", \"targetDarkWhispers\"))) {\n// Non-GMs are not permitted to send Dark Whispers\n  if (!game.user.isGM) {      \n    return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Message.DarkWhispers.NoPermission\"));\n  }\n\n  //TODO: Switch to actor based selection\n  // Only users who have an assigned player character are available to whisper to. \n  let users = []\n  switch (targets) { \n    case \"all\":\n      users = game.users.filter(user => (user.character?.type == \"character\"));\n      break;\n  case \"absent\":\n      users = game.users.filter(user => !user.active && (user.character?.type == \"character\"));\n      break;\n  case \"present\":\n  default:\n     users = game.users.filter(user => user.active && (user.character?.type == \"character\"));\n     break;\n  }\n\n  if (!users) {   \n    return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Message.DarkWhispers.NoEligibleCharacters\"));\n  }\n  \n  // Build list of player / characters to select via dialog\n  //TODO: Map individual Corruption values, rather than increment\n  let corruptionAvailable = 0; // count to check there are characters with corruption to target\n  let checkOptions = \"\";\n  users.forEach(user => {\n    let actorCorruption = {\n      value: game.actors.get(user.character.id).data.data.status.corruption.value, \n      max: game.actors.get(user.character.id).data.data.status.corruption.max\n    };\n    corruptionAvailable += actorCorruption.value;\n    // Make unselectable if character has no Corruption to deal with\n    let canWhisperTo = (actorCorruption.value) ? `enabled title=\"${game.i18n.localize('GMTOOLKIT.Dialog.DarkWhispers.HasCorruption')}\"` : `disabled title=\"${game.i18n.localize('GMTOOLKIT.Dialog.DarkWhispers.NoCorruption')}\"`;\n\n    checkOptions+=`\n        <div class=\"form-group\">\n        <input type=\"checkbox\" name=\"${user.id}\" value=\"${user.name}\" ${canWhisperTo}>\n        <label for=\"${user.id}\"> <strong>${user.character.name}</strong> (${user.name})</label>\n        <label for=\"${user.id}\"> ${actorCorruption.value} / ${actorCorruption.max} ${game.i18n.localize(\"GMTOOLKIT.Status.Corruption\")} </label>\n        </div>\n      `\n  });\n  \n  // abort if no characters have any Corruption\n  if (corruptionAvailable == 0) {   \n    return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Message.DarkWhispers.NoEligibleCharacters\"));\n  };\n\n  // Construct and show form to write whisper message and select target player characters\n  let darkwhisper = (game.tables.getName(game.i18n.localize(\"GMTOOLKIT.Dialog.DarkWhispers.Title\"))) ? await game.wfrp4e.tables.rollTable(\"darkwhispers\") : game.i18n.format(\"GMTOOLKIT.Dialog.DarkWhispers.ImportTable\")\n\n let dialogContent = `\n    <div class=\"form-group \">\n      <label for=\"targets\">${game.i18n.localize(\"GMTOOLKIT.Dialog.DarkWhispers.WhisperTargets\")} </label>\n    </div>\n    ${checkOptions} \n    <div class=\"form-group message\">\n      <label for=\"message\">${game.i18n.localize(\"GMTOOLKIT.Dialog.DarkWhispers.WhisperMessage\")}</label>\n    </div>\n    <div class=\"form-group\">\n      <textarea id=\"message\" name=\"message\" rows=\"4\" cols=\"50\">${darkwhisper?.result || darkwhisper}</textarea>\n    </div>\n    `\n new Dialog({\n  title: game.i18n.localize(\"GMTOOLKIT.Dialog.DarkWhispers.Title\"),\n  content:dialogContent,\n  buttons:{\n    whisper:{   \n      label: game.i18n.localize(\"GMTOOLKIT.Dialog.DarkWhispers.SendWhisper\"),\n      callback: (html) => sendDarkWhispers(html, users, \"private\")\n    }\n  }\n}).render(true);\n}\n\nfunction sendDarkWhispers(html, users, sendmode) {\n  // check for whisper message \n  let messageText = html.find('[name=\"message\"]')[0].value;\n  \n  // build list of selected players ids for whispers target\n  let targets = [];\n  for ( let user of users ) {\n    if (html.find(`[name=\"${user.id}\"]`)[0].checked){\n      targets.push(user.id);\n    }\n  }\n\n  // abort if no whisper or character is selected \n  if (targets.length == 0 || messageText.length == 0) {\n    return ui.notifications.error(game.i18n.format(\"GMTOOLKIT.Message.DarkWhispers.WhisperAborted\", {currentUser: game.users.current.name}));\n  }\n\n  // Construct and send message to whisper targets\n  // Build the translation string based on the setting\n  let messageTemplate = `GMTOOLKIT.Settings.DarkWhispers.message.${game.settings.get(\"wfrp4e-gm-toolkit\", \"messageDarkWhispers\")}`\n  // Parse the translated message\n  let whisperMessage = `${game.i18n.format(messageTemplate, {message: messageText})}`\n  \n  // Add response buttons for chat card\n  // data- attributes are used by listener\n  let responseObjects = `\n    <span class=\"chat-card-button-area\">\n    <a class=\"chat-card-button darkwhisper-button\" data-button=\"actOnWhisper\" data-ask=\"${game.i18n.format(messageText)}\">${game.i18n.localize(\"GMTOOLKIT.Message.DarkWhispers.Accept\")}</a>\n    <a class=\"chat-card-button darkwhisper-button\" data-button=\"denyDarkGods\" data-ask=\"${game.i18n.format(messageText)}\">${game.i18n.localize(\"GMTOOLKIT.Message.DarkWhispers.Reject\")}</a>\n    </span>\n    `\n\n  ChatMessage.create({\n    content: whisperMessage + responseObjects,\n    whisper: targets\n  });\n  \n}\n\n\n/* ==========\n* MACRO: Send Dark Whispers\n* VERSION: 0.9.2\n* UPDATED: 2022-01-04\n* DESCRIPTION: Open a dialog to send a Dark Whisper (WFRP p183) to one or more selected player character(s).\n* TIP: Only player-assigned characters with Corruption can be sent a Dark Whisper. \n* TIP: The placeholder whisper is drawn from the Dark Whispers table. Change this for different random whispers. \n* TIP: The whisper can be edited in the dialog, regardless of what is pre-filled from the Dark Whispers table. \n========== */","folder":null,"sort":0,"permission":{"default":0,"Zo7HSQ75uO8dWUkH":3},"flags":{"core":{"sourceId":"Macro.NsfnGgD7GMH7AMwI"}}}
{"_id":"rzKeTLKp0bOp5SK9","name":"Add XP","type":"script","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/add-xp.svg","scope":"global","command":"addXP();\n\nasync function addXP() {\n\n  // setup: determine group of actors to be awarded experience\n  if (game.user.targets.size < 1) {\n    // (1) all player characters if no tokens are selected\n    awardees = Array.from(game.actors).filter(pc => pc.hasPlayerOwner && pc.type == \"character\");\n  } else {\n    // (2) otherwise, all targeted player character tokens\n    awardees = Array.from(game.user.targets).filter(pc => pc.actor.hasPlayerOwner && pc.actor.type == \"character\");\n  }\n\n  // setup: exit with notice if there are no player-owned characters\n  if (awardees.length < 1) return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Token.TargetPCs\"), {});\n\n  // Get  session ID/date, default XP award and default reason\n  let XP = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultAmount\"))\n  let reason = (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\"))\n  if (reason == \"null\") {\n    reason = \"\"\n  } else {\n    reason = (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\")) \n    let session = game.gmtoolkit.utility.getSession()\n    reason = reason.replace(\"%date%\", session.date)\n    if (session.id != \"null\" ) reason = reason.replace(\"%session%\", session.id)\n  }\n\n  // Prompt for XP if option is set\n  if (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPPrompt\")) {\n    let awardeeList = \"<ul>\"\n    awardees.forEach (pc => {\n      awardeeList +=  `<li>${pc?.actor?.name || pc.name}</li>` \n    })\n    awardeeList += \"</ul>\"\n    const dialog = new Dialog({\n      title: (game.i18n.localize('GMTOOLKIT.Dialog.AddXP.Title')),\n      content: `<form>\n              <p>${game.i18n.format(\"GMTOOLKIT.Dialog.AddXP.Recipients\", {recipients : awardeeList})}</p>\n              <div class=\"form-group\">\n                <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Prompt\")}</label> \n                <input type=\"text\" id=\"add-xp\" name=\"add-xp\" value=\"${XP}\" />\n              </div>\n              <div class=\"form-group\">\n                <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Reason\")}</label> \n                <input type=\"text\" id=\"xp-reason\" name=\"xp-reason\" value=\"${reason}\" />\n              </div>\n          </form>`,\n      buttons: {\n        yes: {\n          icon: \"<i class='fas fa-check'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n          callback: (html) => {\n            let XP = Math.round(html.find('#add-xp').val());\n            if (isNaN(XP)) return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.InvalidXP\"))\n            let reason =  html.find('#xp-reason').val();\n            updateXP(awardees, XP, reason);\n          }\n        },\n        no: {\n          icon: \"<i class='fas fa-times'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\"),\n        },\n      },\n      default: \"yes\"\n  }).render(true);\n  } else {\n    updateXP(awardees, XP, reason)\n  }\n\n} // END: addXP\n\nfunction updateXP(awardees, XP, reason) {\n  let chatContent = \"\"\n\n  // cycle through player characters, gathering experience change data for report message\n  awardees.forEach ( pc  => {\n    recipient = pc?.actor?.name || pc.name \n    XPTotal = pc?.details?.experience?.total || pc.actor.data.data.details.experience.total; \n    newXPTotal = Math.max(XPTotal + XP,0);\n    XPCurrent = pc?.details?.experience?.current  || pc.actor.data.data.details.experience.current; \n    newXPCurrent = Math.max(XPCurrent + XP,0);\n\n    // update token actor or actor\n    pc?.actor ? pc.actor.awardExp(XP, reason) : pc.awardExp(XP, reason)\n\n    // build report message \n    chatContent += game.i18n.format(\"GMTOOLKIT.AddXP.Success\", {recipient, XPTotal, newXPTotal, XPCurrent, newXPCurrent} )  \n  }); // end cycle\n  \n// confirm changes made in whisper to GM\n    let chatData = game.wfrp4e.utility.chatDataSetup(chatContent, \"gmroll\", false)\n    chatData.flavor = game.i18n.format(\"GMTOOLKIT.AddXP.Flavor\", {XP, reason})\n    ChatMessage.create(chatData, {});  \n    console.log(chatContent)\n\n} // END: updateXP\n\n\n/* ==========\n * MACRO: Add XP\n * VERSION: 0.8.0\n * UPDATED: 2021-12-30\n * DESCRIPTION: Adds a set amount of XP to all or targeted player character(s). Adds XP update note to the Chat log.\n * TIP: Characters must have a player assigned. \n * TIP: Default XP amount and reason can be preset in module settings, along with option to bypass prompt for XP amount each time.\n * TIP: Non-whole numbers are rounded off. Negative numbers are subtracted. \n ========== */","folder":null,"sort":0,"permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"flags":{}}
{"_id":"tiKEfs1nB7zAMgYg","name":"Pull Everyone to Scene","permission":{"default":0,"k5y1jEYMBqd9uLUx":3},"type":"script","flags":{},"scope":"global","command":"/* Yanks every player into the scene that the GM is on. \n * Optionally activates the scene, depending on module setting. \n */\n\npullEveryoneToScene();\n\nasync function pullEveryoneToScene() {\n    if (!game.user.isGM) {\n        ui.notifications.error(game.i18n.localize('GMTOOLKIT.Message.ScenePullActivate.NoPermission'), {});\n    }\n\n    switch (game.settings.get(\"wfrp4e-gm-toolkit\", \"scenePullActivate\")) {\n        case \"prompt\": \n            const dialog = new Dialog({\n                title: (game.i18n.localize('GMTOOLKIT.Dialog.ScenePullActivate.Title')),\n                content: `<form>\n                        <div class=\"form-group\">\n                        <label>\n                            ${game.i18n.localize(\"GMTOOLKIT.Dialog.ScenePullActivate.Prompt\")}         \n                            </label>\n                        </div>\n                    </form>`,\n                buttons: {\n                    activate: {\n                        label: \"Activate Scene\",\n                        callback: async () => pullToScene(true)\n                        },\n                    pull: {\n                        label: \"Pull Only\",\n                        callback: async () => pullToScene(false)\n                        },\n                },\n                default: \"pull\"\n            }).render(true);\n            break;\n        case \"always\": \n            pullToScene(true)\n            break;\n        case \"never\":\n            pullToScene(false)\n            break;\n    }\n\n    function pullToScene(activateScene) {\n        let thisScene = game.scenes.viewed\n        if (activateScene) {\n            thisScene.update({\"active\" : true})\n            let sceneActiveState = thisScene.data.active\n            ui.notifications.notify(game.i18n.format('GMTOOLKIT.Message.ScenePullActivate.Activated', {sceneName: thisScene.name}));\n        } else { \n            for ( let u of game.users.players ) {\n                game.socket.emit(\"pullToScene\", thisScene.id, u.id);\n            }\n            let sceneActiveState = String()\n            if (thisScene.data.active == true ) {\n                sceneActiveState = game.i18n.localize('GMTOOLKIT.Scene.Active')\n            } else {\n                sceneActiveState = game.i18n.localize('GMTOOLKIT.Scene.NotActive');\n            }\n            ui.notifications.notify(game.i18n.format('GMTOOLKIT.Message.ScenePullActivate.Pulled', {sceneName: thisScene.name, sceneActiveState}))\n        }\n    }\n};","author":"k5y1jEYMBqd9uLUx","img":"modules/wfrp4e-gm-toolkit/assets/icons/pull-to-scene.svg","actorIds":[]}
{"_id":"wN47JNwM2POBSUUm","name":"Make Secret Party Test","type":"script","author":"CIvnsqepNlj0qrKz","img":"modules/wfrp4e-gm-toolkit/assets/icons/make-secret-party-test.svg","scope":"global","command":"// === Set up test parameters\nlet targetSkill = \"Perception\";  // eg, basic skill\n// let targetSkill = \"Stealth (Rural)\";  // eg, grouped skill\n// let targetSkill = \"Play (Lute)\";  // eg, advanced skill\n\nlet silentTest = true;  // true: to bypass roll dialog and post results directly to chat using the following default options\n// let silentTest = false;  // false: to use the native Roll Dialog for control over talents and other modifiers/bonuses, which may vary by character; \n\n// === Set default options for silent tests (ignored for interactive tests)\nlet rollMode = \"blindroll\" // choose from \"gmroll\", \"blindroll\", \"selfroll\",  \"public\"\nlet slBonus = 0\nlet successBonus = 0\nlet testModifier = +20 // game.wfrp4e.config.difficultyModifiers[(\"average\")]\n// --- testModifier can be numeric or reference built-in system difficultyModifiers \n// --- (eg, 'game.wfrp4e.config.difficultyModifiers[(\"average\")]' for +20)\n// --- accepted difficultyModifier values are listed in the REFERENCES section below\n\n// === Carry out the test if you are a GM\nif (game.user.isUniqueGM) \n    {makeSecretPartyTest(targetSkill)} \nelse \n    {ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Message.MakeSecretPartyTest.NoPermission\"), {})\n};\n\n// === Where the magic happens. \n\nasync function makeSecretPartyTest(targetSkill) {\n    let party = Array.from(game.actors).filter(a => a.hasPlayerOwner && a.type == \"character\");\n    for (let pc of party) {\n        // stack tests rather than await: cancelling a non-silent test during an await(ed) call will abandon all subsequent tests\n        let pcSkill = game.gmtoolkit.utility.hasSkill(pc, targetSkill, \"silent\")\n        if (pcSkill != null) { \n            // Roll against the skill if the actor has it ...\n            pc.setupSkill(pcSkill, {bypass: silentTest, testModifier, slBonus, successBonus, rollMode, title : `${pcSkill.name} Test (${pc.name})`}).then(setupData => {pc.basicTest(setupData)});\n        } else {\n            // ... or fallback to underlying characteristic if they don't\n            pcSkill = await game.wfrp4e.utility.findSkill(targetSkill)\n            // TODO: optionally step-adjust the difficulty in case of fallback\n            if (pcSkill.advanced.value == \"adv\" && !game.settings.get(\"wfrp4e-gm-toolkit\", \"fallbackAdvancedSkills\")) {\n                ui.notifications.info(`${game.i18n.format(\"GMTOOLKIT.Message.MakeSecretPartyTest.AbortAdvancedSkillTest\", {character: pc.name, skill: targetSkill})}`)\n                continue \n            }\n            let skillCharacteristic = game.wfrp4e.config.characteristics[pcSkill.characteristic.value]\n            pc.setupCharacteristic(pcSkill.characteristic.value, {bypass: silentTest, testModifier, slBonus, successBonus, rollMode, title : `${skillCharacteristic} Test for ${pcSkill.name} (${pc.name})`}).then(setupData => {pc.basicTest(setupData)});\n        }        \n    }\n}\n\n/* ==========\n * MACRO: Make Secret Party Test\n * VERSION: 0.8.0\n * UPDATED: 2021-12-31\n * DESCRIPTION: Macro template for GMs to run secret skill tests for their party. \n * TIP: Create copies of this macro and adjust the parameters (and title and/or icon) for different skill tests. Add them to your macro bar for one-click resolution. \n * TIP: By default, tests are rolled blind. Right-click a test result in the chat log to show the results to players.\n * TIP: You can use the results of a secret test in an opposed test as normal (using the double arrows in the chat log card.), such as secret Stealth v Perception tests\n ========== */\n\n/* === REFERENCES: \n* --- Accepted difficultyModifier values that can be used for testModifier\n* \"veasy\": \"Very Easy (+60)\",\n* \"easy\": \"Easy (+40)\",\n* \"average\": \"Average (+20)\",\n* \"challenging\": \"Challenging (+0)\",\n* \"difficult\": \"Difficult (-10)\",\n* \"hard\": \"Hard (-20)\",\n* \"vhard\": \"Very Hard (-30)\",\n* \"futile\": \"Futile (-40)\" // requires Enemy in Shadows module\n* \"impossible\": \"Impossible (-50)\" // requires Enemy in Shadows module\n*/","folder":null,"sort":0,"permission":{"default":0,"CIvnsqepNlj0qrKz":3},"flags":{"core":{"sourceId":"Macro.lQMBdQOkcPIIjfIe"}}}
