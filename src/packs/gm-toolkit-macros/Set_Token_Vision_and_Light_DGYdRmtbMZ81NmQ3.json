{
  "_id": "DGYdRmtbMZ81NmQ3",
  "name": "Set Token Vision and Light",
  "type": "script",
  "author": "Zo7HSQ75uO8dWUkH",
  "img": "modules/wfrp4e-gm-toolkit/assets/icons/set-token-vision-light.svg",
  "scope": "global",
  "command": "setTokenVisionLight()\n\nasync function canvasTokensUpdate (data) {\n  const updates = canvas.tokens.controlled\n    .map(token => mergeObject({ _id: token.id }, data))\n  await canvas.scene.updateEmbeddedDocuments(\"Token\", updates)\n}\n\nasync function setTokenVisionLight () {\n  if (canvas.tokens.controlled.length < 1) return ui.notifications.error( game.i18n.localize(\"GMTOOLKIT.Token.Select\"), {} )\n\n  let applyChanges = false\n\n  new Dialog({\n    title: game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.Title\"),\n    content: `\n        <form> \n          <div class=\"form-group\">\n            <label>\n            ${game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.VisionType\")}\n          </label>\n            <select id=\"vision-type\" name=\"vision-type\"> \n              <option value=\"normalVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Normal\")} \n              </option> \n              <option value=\"blindedVision\"> \n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Blinded\")} \n              </option>\n              <option value=\"nightVision\"> \n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Night\")} \n              </option>\n              <option value=\"darkVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.Dark\")} \n              </option>\n              <option value=\"noVision\">\n              ${game.i18n.localize(\"GMTOOLKIT.Vision.None\")} \n              </option>\n            </select>\n          </div>\n          <div class=\"form-group\">\n            <label>\n            ${game.i18n.localize(\"GMTOOLKIT.Dialog.SetVisionLight.LightSource\")} \n            </label>\n            <select id=\"light-source\" name=\"light-source\">\n              <option value=\"none\"> \n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.NoLight\")}\n              </option>\n              <option value=\"matches\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Matches\")} \n              </option>\n              <option value=\"candle\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Candle\")} \n              </option>\n              <option value=\"davrich-lamp\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.DavrichLamp\")} \n              </option>\n              <option value=\"torch\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Torch\")}\n              </option>\n              <option value=\"lantern\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Lantern\")}\n              </option>\n              <option value=\"storm-broad\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.StormLantern.Dim\")} \n              </option>\n              <option value=\"storm-narrow\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.StormLantern.Bright\")} \n              </option>\n              <option value=\"ablaze\"> \n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Ablaze\")} \n              </option>\n              <option value=\"light\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Light\")}\n              </option>\n              <option value=\"witchlight\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Witchlight\")}\n              </option>\n              <option value=\"glowing-skin\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.GlowingSkin\")}\n              </option>\n              <option value=\"soulfire\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Soulfire\")} \n              </option>\n              <option value=\"pha\">\n              ${game.i18n.localize(\"GMTOOLKIT.LightSource.Pha\")} \n              </option>\n            </select>\n          </div>\n        </form>\n        `,\n    buttons: {\n      no: {\n        icon: \"<i class='fas fa-times'></i>\",\n        label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\")\n      },\n      yes: {\n        icon: \"<i class='fas fa-check'></i>\",\n        label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n        callback: () => applyChanges = true\n      }\n    },\n    default: \"yes\",\n    close: async html => {\n      if (applyChanges) {\n\n        for ( const token of canvas.tokens.controlled ) {\n\n          // Define a set of baseline values. Light Source and Vision choices will only change the properties that differ. Not all of the options available since Foundry v9 are used.\n          // Baseline Night Vision Advances\n          let advNightVision = 0\n          // Baseline Vision Values\n          let sightAngle = 360\n          let sightAttenuation = 0.1\n          let sightBrightness = 0\n          let sightColor = null\n          let sightContrast = 0\n          let sightRange = 0\n          let sightSaturation = 0\n          let visionMode = \"basic\"\n          // Baseline Light Source Values\n          let lightAlpha = 0.5 // Previously lightColorIntensity\n          let lightAngle = 360\n          let lightAnimationType = null\n          let lightAnimationSpeed = 1\n          let lightAnimationIntensity = 1\n          let lightAnimationReverse = false\n          let lightAttenuation = 0.5\n          let lightBright = 0\n          let lightColor = null\n          let lightColoration = 1 // Coloration Technique: 1=AdaptiveLuminance, 10= NaturaLLight\n          let lightContrast = 0\n          let lightDarknessMax = 1\n          let lightDarknessMin = 0\n          let lightDim = 0\n          let lightLuminosity = 0\n          let lightSaturation = 0\n          let lightShadows = 0\n\n          let visionType = html.find('[name=\"vision-type\"]')[0].value // TODO: default vision option based on condition -> trait -> talent. Issue Log: https://github.com/Jagusti/fvtt-wfrp4e-gmtoolkit/issues/42\n          let item // Used for finding whether token has Night Vision or Dark Vision\n          let lightSource = html.find('[name=\"light-source\"]')[0].value\n\n          // Get Light Source Values\n          switch (lightSource) {\n            case \"none\":\n            case \"storm-shut\":\n              lightDim = 0\n              break\n            case \"matches\":\n              lightDim = 5\n              lightBright = 2\n              lightColor = \"#ffaa00\"\n              lightAlpha = 0.1\n              lightAnimationIntensity = 4\n              lightAnimationSpeed = 4\n              lightAnimationType = \"flame\"\n              break\n            case \"candle\":\n              lightDim = 10\n              lightBright = 5\n              lightColor = \"#ffaa00\"\n              lightAlpha = 0.2\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"flame\"\n              break\n            case \"davrich-lamp\":\n              lightDim = 10\n              lightBright = 5\n              lightColor = \"#ffaa00\"\n              lightAlpha = 0.5\n              lightAnimationIntensity = 2\n              lightAnimationSpeed = 2\n              lightAnimationType = \"torch\"\n              break\n            case \"torch\":\n              lightDim = 15\n              lightBright = 7.5\n              lightColor = \"#ffaa00\"\n              lightAlpha = 0.3\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"flame\"\n              break\n            case \"lantern\":\n              lightDim = 20\n              lightBright = 10\n              lightColor = \"#ffcc66\"\n              lightAlpha = 0.4\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"torch\"\n              break\n            case \"storm-broad\":\n              lightDim = 20\n              lightBright = 10\n              lightColor = \"#ffcc66\"\n              lightAlpha = 0.4\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"torch\"\n              break\n            case \"storm-narrow\":\n              lightDim = 30\n              lightBright = 20\n              lightColor = \"#ffcc66\"\n              lightAlpha = 0.6\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"torch\"\n              lightAngle = 90\n              break\n            case \"light\":\n              lightDim = 15\n              lightBright = 7.5\n              lightColor = \"#99ffff\"\n              lightAlpha = 0.4\n              lightAnimationIntensity = 3\n              lightAnimationSpeed = 3\n              lightAnimationType = \"pulse\"\n              lightColoration = 10 // Natural Light\n              break\n            case \"witchlight\":\n              lightDim = 20\n              lightBright = 10\n              lightColor = \"#99ffff\"\n              lightAlpha = 0.4\n              lightAnimationIntensity = 4\n              lightAnimationSpeed = 2\n              lightAnimationType = \"chroma\"\n              break\n            case \"glowing-skin\":\n              lightDim = 10\n              lightBright = 3\n              lightColor = \"#ffbd80\"\n              lightAlpha = 0.3\n              lightAnimationIntensity = 2\n              lightAnimationSpeed = 2\n              lightAnimationType = \"pulse\"\n              break\n            case \"ablaze\":\n              lightDim = 15\n              lightBright = 7.5\n              lightColor = \"#ff7733\"\n              lightAlpha = 0.5\n              lightAnimationIntensity = 5\n              lightAnimationSpeed = 4\n              lightAnimationType = \"flame\"\n              break\n            case \"soulfire\":\n              lightDim = 15\n              lightBright = 7.5\n              lightColor = \"#ff7733\"\n              lightAlpha = 0.5\n              lightAnimationIntensity = 4\n              lightAnimationSpeed = 4\n              lightAnimationType = \"flame\"\n              break\n            case \"pha\":\n              lightDim = token.actor.system.characteristics.wp.bonus\n              lightBright = token.actor.system.characteristics.wp.bonus\n              lightColor = \"#ffddbb\"\n              lightAlpha = 0.6\n              lightAnimationIntensity = 2\n              lightAnimationSpeed = 2\n              lightAnimationType = \"sunburst\"\n              break\n            default:\n              lightDim = token.document.light.dim\n              lightBright = token.document.light.bright\n              lightAngle = token.document.light.angle\n              lightColor = token.document.light.color\n          }\n\n          // Get Vision Type Values\n          switch (visionType) {\n            case \"blindedVision\":\n              sightBrightness = 1\n              sightRange = 1\n              sightSaturation = 1\n              break\n            case \"noVision\":\n              sightRange = 0\n              sightBrightness = -1\n              lightDim = 0\n              lightBright = 0\n              break\n            case \"darkVision\":\n              const darkvision = game.i18n.localize(\"NAME.DarkVision\").toLowerCase()\n              item = token.actor.items.find(\n                i => i.name.toLowerCase() === darkvision\n              )\n              if (item !== undefined) {\n                sightRange = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeDarkVision\"))\n              } else {\n                game.settings.get(\"wfrp4e-gm-toolkit\", \"overrideDarkVision\")\n                  ? sightRange = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeDarkVision\"))\n                  : sightRange = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\"))\n              }\n              sightBrightness = sightRange / 2\n              break\n            case \"nightVision\":\n              const nightvision = game.i18n.localize(\"NAME.NightVision\").toLowerCase()\n              // Night Vision requires some minimal illumination to provide a benefit\n              if (\n                game.scenes.viewed.darkness < 1\n                | lightDim > 0\n                | game.scenes.viewed.globalLight\n              ) {\n                item = token.actor.items.find(\n                  i => i.name.toLowerCase() === nightvision\n                )\n                if (item === undefined) {\n                  game.settings.get(\"wfrp4e-gm-toolkit\", \"overrideNightVision\")\n                    ? advNightVision = 1\n                    : advNightVision = 0\n                } else {\n                  for (let item of token.actor.items) {\n                    if (item.name.toLowerCase() === nightvision ) {\n                      switch (item.type) {\n                        case \"trait\":\n                          advNightVision = 1\n                          break\n                        case \"talent\":\n                          advNightVision += item.system.advances.value\n                          break\n                      }\n                    }\n                  }\n                }\n                if (advNightVision === 0) {\n                  sightRange = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\"))\n                  break\n                }\n                sightRange = Math.max(\n                  (20 * advNightVision) + lightDim,\n                  Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\"))\n                )\n                sightColor = null\n                visionMode = \"basic\"\n                sightSaturation = -1\n              }\n              console.log(`Night Vision Advances ${advNightVision}`)\n              break\n            case \"normalVision\":\n              sightRange = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"rangeNormalSight\"))\n              sightBrightness = 0\n              sightColor = null\n              visionMode = \"basic\"\n              break\n            default:\n              sightRange = token.document.sight.range\n              sightBrightness = token.document.sight.brightness\n              sightColor = null\n              visionMode = \"basic\"\n          }\n\n          // Update Token\n          await token.document.update({\n            sight: {\n              angle: sightAngle,\n              attenuation: sightAttenuation,\n              brightness: sightBrightness,\n              color: sightColor,\n              contrast: sightContrast,\n              enabled: true,\n              range: sightRange,\n              saturation: sightSaturation,\n              visionMode: visionMode\n            },\n            light: {\n              alpha: lightAlpha,\n              angle: lightAngle,\n              animation: {\n                type: lightAnimationType,\n                speed: lightAnimationSpeed,\n                intensity: lightAnimationIntensity,\n                reverse: lightAnimationReverse\n              },\n              attenuation: lightAttenuation,\n              bright: lightBright,\n              color: lightColor,\n              coloration: lightColoration,\n              contrast: lightContrast,\n              darkness: {\n                max: lightDarknessMax,\n                min: lightDarknessMin\n              },\n              dim: lightDim,\n              luminosity: lightLuminosity,\n              saturation: lightSaturation,\n              shadows: lightShadows\n            }\n          })\n          token.refresh(true)\n        }\n\n        canvasTokensUpdate({ \"sight.enabled\": true })\n\n      }\n    }\n  }).render(true)\n}\n\n\n/* ==========\n * MACRO: Set Token Vision and Light\n * VERSION: 6.0.3\n * UPDATED: 2023-04-25\n * DESCRIPTION: Open a dialog for quickly changing vision and lighting parameters of the selected token(s).\n * TIP: Default sight range and Darkvision / Night Vision overrides can be configured in Configure Token Vision Settings under Module Settings.\n ========== */",
  "folder": null,
  "sort": 0,
  "flags": {
    "core": {
      "sourceId": "Macro.issAGdpFxchQw2zp"
    },
    "wfrp4e-gm-toolkit": {
      "version": "0.9.5"
    }
  },
  "ownership": {
    "default": 0
  },
  "_stats": {
    "systemId": "wfrp4e",
    "systemVersion": "6.4.0",
    "coreVersion": "10.291",
    "createdTime": null,
    "modifiedTime": 1682456871708,
    "lastModifiedBy": "WpuDIfNQnefaTyuV"
  },
  "_key": "!macros!DGYdRmtbMZ81NmQ3"
}
